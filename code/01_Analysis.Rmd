---
title: "01_Analysis"
author: "Connor Quiroz"
date: "2025-03-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# General data cleaning + visualization + analysis packages
library(tidyverse)
library(ggformula)
library(countrycode)
library(data.table)
library(arrow)
library(cowplot)
library(RColorBrewer)

# Map creation
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)

# Load in packages needed for ARTIS
library(devtools)
library(tidytext)
# devtools::install_github("davidsjoberg/ggsankey")
library(ggsankey)
# devtools::install_github("Seafood-Globalization-Lab/exploreARTIS@v1.0.0", dependencies = TRUE)
library(exploreARTIS)
```

```{r initialize functions}
# Ocean polygon
ocean <- st_polygon(list(cbind(c(seq(-180, 179, len = 100), rep(180, 100), 
                        seq(179, -180, len = 100), rep(-180, 100)),
                      c(rep(-90, 100), seq(-89, 89, len = 100),
                        rep(90, 100), seq(89, -90, len = 100))))) %>%
  st_sfc(crs = "WGS84") %>%
  st_as_sf()

# Map creation function
create_map <- function(data = data, fill = "prop_missing", country.col.name) {
  world_map <- ne_countries(scale = "medium", returnclass = "sf")

world_map <- world_map %>%
  left_join(data, by = c("iso_a3" = country.col.name))
  
  world_map %>%
ggplot() +
  geom_sf(data = ocean, fill = "#8080ff80") +
  geom_sf(aes(fill = !!sym(fill)), color = "black") + 
  scale_fill_viridis_c(option = "plasma") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  coord_sf(crs = "+proj=robin")
}
```

# Objective

Calculate the risk index given the components for a country's exposure, sensitivity, and adaptive capacity. 

```{r calculate risk}
e_s_ac_data <- read_parquet("../output/e_s_ac_data.parquet")

e_s_ac_data_entire_portfolio <- read_parquet("../output/e_s_ac_data_entire_portfolio.parquet")

# Calculate risk
source("../R/calculate_risk.R")

risk_foreign_imports <- calculate_risk(e_s_ac_data) %>%
  mutate(coverage = "foreign imports")
risk_overall <- calculate_risk(e_s_ac_data_entire_portfolio) %>%
  mutate(coverage = "entire portfolio")

# Look at correlations between vulnerability and E + S + AC
pairs(risk[,2:5])
cor_vals <- cor(risk[,2:5])


# Save correlation values to RDS
saveRDS(cor_vals, "../output/cor_vals.rds")

# Look at the distribution of the pct change in stocks globally by shared socioeconomic pathway.
e_s_ac_data %>%
  ggplot(aes(x = pct_change)) +
  geom_histogram(color = "black") +
  facet_wrap(~ scenario) +
  theme_cowplot() +
  labs(x = "% Change in stock", y = "# countries")

# Who sources from countries that are more or less vulnerable
consumption %>%
  filter(year == 2019) %>%
  left_join(risk, by = c("producer_iso3c" = "consumer_iso3c")) %>%
  rename(producer_risk = "vulnerability") %>%
  filter(producer_iso3c != consumer_iso3c) %>%
  mutate(risk_sum = live_weight_t * producer_risk) %>%
  filter(!is.na(producer_risk)) %>%
  group_by(consumer_iso3c) %>%
  summarize(total_risk = -log(-sum(risk_sum))) %>%
  rename(eez_iso3c = "consumer_iso3c") %>%
  create_map(fill = "total_risk") +
  labs(fill = "Sourcing riskiness from foreign imports") +
  theme(legend.ticks = element_blank(),
        legend.text = element_blank())
```

```{r how much risk is coming from foreign and domestic sources?}
risk_comparison  <- bind_rows(risk_foreign_imports, risk_overall) %>%
  # Keep only the columns you need for the comparison
  select(consumer_iso3c, region, coverage, vulnerability) %>%
  pivot_wider(
    names_from = coverage, 
    values_from = vulnerability
  ) %>%
  # Clean up column names (replace spaces/special chars if needed)
  rename(
    foreign_imports_vuln = `foreign imports`,
    entire_portfolio_vuln = `entire portfolio`
  ) %>%
  mutate(foreign_imports_vuln = abs(foreign_imports_vuln),
         entire_portfolio_vuln = abs(entire_portfolio_vuln
)) %>%
  # Calculate foreign contribution metrics
  mutate(
    # What percentage of total vulnerability comes from foreign imports
    foreign_contribution_pct = (foreign_imports_vuln / entire_portfolio_vuln) * 100,
    
    # Difference between foreign and total vulnerability  
    vulnerability_difference = foreign_imports_vuln - entire_portfolio_vuln,
    
    # How much does domestic production reduce vulnerability?
    domestic_buffer = entire_portfolio_vuln - foreign_imports_vuln
  ) %>%
  # Remove rows where we don't have both measures
  filter(!is.na(foreign_imports_vuln), !is.na(entire_portfolio_vuln)) %>%
  arrange(-foreign_contribution_pct)
```


```{r run sensitivity analysis}
source("../R/sensitivity_analysis")
```

