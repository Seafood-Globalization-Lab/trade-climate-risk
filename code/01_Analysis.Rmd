---
title: "01_Analysis"
author: "Connor Quiroz"
date: "2025-03-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r calculate risk}
e_s_ac_data <- read_parquet("../output/e_s_ac_data.parquet")

# Calculate adaptive capacity across variables
adaptive_capacity_calcs <- e_s_ac_data %>%
  mutate(across(c(gdp, gdp_trade, sanitation, 
                  supermarkets, life_expectancy, prop_labor, hci, gov_effectiveness,
                  fsc, rol), ~ ( . - min(., na.rm = TRUE) ) / ( max(., na.rm = TRUE) - min(., na.rm = TRUE) ), .names = "{.col}_scaled")) %>% # scale variables using min/max scaling
  mutate(gdp_scaled = gdp_scaled * (1/3), # Weight each AC variable within AC component (will add to 4 for country if each value is it's max value)
         gdp_trade_scaled = gdp_trade_scaled * (1/3),
         sanitation_scaled = sanitation_scaled * (1/3),
         supermarkets_scaled = supermarkets_scaled * (1/3),
         life_expectancy_scaled = life_expectancy_scaled * (1/3),
         prop_labor_scaled = prop_labor_scaled * (1/3),
         hci_scaled = hci * 1,
         gov_effectiveness_scaled = gov_effectiveness_scaled * (1/3),
         fsc_scaled = fsc_scaled * (1/3),
         rol_scaled = rol_scaled * (1/3)) %>%
  distinct(consumer_iso3c, .keep_all = TRUE) %>%
  group_by(consumer_iso3c) %>%
  mutate(adaptive_capacity = sum(gdp_scaled, gdp_trade_scaled,
                                 sanitation_scaled, supermarkets_scaled,
                                 life_expectancy_scaled,
                                 prop_labor_scaled,
                                 hci_scaled,
                                 gov_effectiveness_scaled,
                                 fsc_scaled,
                                 rol_scaled)) %>%
  mutate(adaptive_capacity = adaptive_capacity * 0.5) %>% # Divide by two, meaning max value would now = two, which would nullify max level expsorue + sensitivity
  filter(!is.na(adaptive_capacity)) %>%
  select(consumer_iso3c, adaptive_capacity)


# Calculate vulernability (Risk = Exposure + Risk - Adaptive Capacity)
risk <- left_join(e_s_ac_data, adaptive_capacity_calcs, by = "consumer_iso3c") %>%
  filter(!is.na(adaptive_capacity),
         scenario == "2030ssp126") %>%
  mutate(across(c(change_in_stock, importance_on_protein_cons,
                  foreign_dependency), ~ ( . - min(., na.rm = TRUE) ) / ( max(., na.rm = TRUE) - min(., na.rm = TRUE) ), .names = "{.col}_scaled")) %>%
  group_by(consumer_iso3c) %>%
  mutate(importance_on_protein_cons_scaled = importance_on_protein_cons * 0.5,
         foreign_dependency_scaled = foreign_dependency_scaled * 0.5,
         sensitivity = sum(importance_on_protein_cons_scaled,foreign_dependency_scaled, na.rm = TRUE)) %>%
  filter(!is.na(foreign_dependency_scaled),
                !is.na(importance_on_protein_cons_scaled)) %>%
  rename(exposure = "change_in_stock_scaled") %>%
  select(consumer_iso3c, exposure, sensitivity, adaptive_capacity) %>%
  mutate(adaptive_capacity = adaptive_capacity) %>%
  mutate(vulnerability = (exposure + sensitivity) - adaptive_capacity)

# Map vulnerability
risk %>%
  rename(eez_iso3c = "consumer_iso3c") %>%
create_map(fill = "vulnerability") +
  labs(fill = "Vulnerability score")

# Look at correlations between vulnerability and E + S + AC
pairs(risk[,2:5])
cor(risk[,2:5])
```

```{r run sensitivity analysis on AC variables and componends}

```

