---
title: "01_Analysis"
author: "Connor Quiroz"
date: "2025-03-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# General data cleaning + visualization + analysis packages
library(tidyverse)
library(ggformula)
library(countrycode)
library(data.table)
library(arrow)
library(cowplot)
library(RColorBrewer)

# Map creation
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(dirmult)

# Load in packages needed for ARTIS
library(devtools)
library(tidytext)
# devtools::install_github("davidsjoberg/ggsankey")
library(ggsankey)
# devtools::install_github("Seafood-Globalization-Lab/exploreARTIS@v1.0.0", dependencies = TRUE)
library(exploreARTIS)
```

# Objectives

The goal of this document is to
- call on a script that acquires exposure, sensitivity, and adaptive capacity data
- use the exposure, sensitivty, and adaptive capacity data to calculate the climate risk in countries' imports and entire portfolio
- run a sensitivity analysis each of the components of adaptive capacity to ensure there are no variables that have an excessive contribution to risk

```{r initialize functions}

# Change this line based on user
file_path <- "C:/Users/cjqui/OneDrive/Desktop/2024-2025/SGL/Chapter 2/data/"
source("00_Preprocess_Data.R", directory_path = file_path) # function that runs a script to acquire exposure, sensitivity, and adaptive capacity data
source("../R/create_map.R") # function for creating maps
source("../R/calculate_risk.R") # function for calculating risk
source("../R/sensitivity_analysis.R") # function for running a sensitivity analysis on adaptive capacity variables
```

# Objective

Calculate the risk index given the components for a country's exposure, sensitivity, and adaptive capacity. 

```{r calculate risk}
# Get exposure, sensitivty, and adaptive capacity data for foreign imports
e_s_ac_data <- acquire_e_s_ac_data(foreign = FALSE)

# Get exposure, sensitivty, and adaptive capacity data for foreign imports
e_s_ac_data_entire_portfolio <- acquire_e_s_ac_data(foreign = TRUE)




risk_foreign_imports <- calculate_risk(e_s_ac_data) %>%
  mutate(coverage = "foreign imports")
risk_overall <- calculate_risk(e_s_ac_data_entire_portfolio) %>%
  mutate(coverage = "entire portfolio")

# Look at correlations between vulnerability and E + S + AC
pairs(risk_foreign_imports[,2:5])
cor_vals <- cor(risk_foreign_imports[,2:5])
# Save correlation values to RDS
saveRDS(cor_vals, "../output/cor_vals.rds")

# Look at the distribution of the pct change in stocks globally by shared socioeconomic pathway.
e_s_ac_data %>%
  ggplot(aes(x = pct_change)) +
  geom_histogram(color = "black", boundary = 0) +
  facet_wrap(~ scenario) +
  theme_cowplot() +
  labs(x = "% Change in stock", y = "# countries")
```

```{r how much risk is coming from foreign and domestic sources?}
risk_comparison  <- bind_rows(risk_foreign_imports, risk_overall) %>%
  # Keep only the columns you need for the comparison
  select(consumer_iso3c, region, coverage, vulnerability) %>%
  pivot_wider(
    names_from = coverage, 
    values_from = vulnerability
  ) %>%
  # Clean up column names (replace spaces/special chars if needed)
  rename(
    foreign_imports_vuln = `foreign imports`,
    entire_portfolio_vuln = `entire portfolio`
  ) %>%
  mutate(foreign_imports_vuln = foreign_imports_vuln,
         entire_portfolio_vuln = entire_portfolio_vuln
) %>%
  # Calculate foreign contribution metrics
  mutate(
    # What percentage of total vulnerability comes from foreign imports
    foreign_contribution_pct = (foreign_imports_vuln / entire_portfolio_vuln) * 100,
    
    # Difference between foreign and total vulnerability  
    vulnerability_difference = foreign_imports_vuln - entire_portfolio_vuln,
    
    # How much does domestic production reduce vulnerability?
    domestic_buffer = entire_portfolio_vuln - foreign_imports_vuln
  ) %>%
  # Remove rows where we don't have both measures
  filter(!is.na(foreign_imports_vuln), !is.na(entire_portfolio_vuln)) %>%
  arrange(-foreign_contribution_pct)
```


```{r run sensitivity analysis}
source("../R/sensitivity_analysis.R")

sensitivity_analysis(e_s_ac_data)
sensitivity_analysis(e_s_ac_data_entire_portfolio)
```

