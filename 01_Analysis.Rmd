---
title: "01_Analysis"
author: "Connor Quiroz"
date: "2025-03-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# General data cleaning + visualization + analysis packages
library(tidyverse)
library(ggformula)
library(countrycode)
library(data.table)
library(arrow)
library(cowplot)
library(RColorBrewer)

# Map creation
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(dirmult)

# Load in packages needed for ARTIS
library(devtools)
library(tidytext)
# devtools::install_github("davidsjoberg/ggsankey")
library(ggsankey)
# devtools::install_github("Seafood-Globalization-Lab/exploreARTIS@v1.0.0", dependencies = TRUE)
library(exploreARTIS)
```

# Objectives

The purpose of this 01_Analysis is to:

- **Run a data acquisition script** that gathers  
  - Exposure data  
  - Sensitivity data  
  - Adaptive capacity data  

- **Calculate climate risk** for each country's imports and overall seafood portfolio  
  using the combined exposure, sensitivity, and adaptive capacity datasets.

- **Perform a sensitivity analysis** on adaptive capacity components  
  to ensure no single variable has a disproportionate effect on total risk.

> ðŸ’¡ **User input:**  
> In the code chunk below, replace `file_path` with the path to your input data folder.  
> Once specified, the script will automatically execute all subsequent steps.


```{r initialize functions}
source("00_Preprocess_Data.R") # function that runs a script to acquire exposure, sensitivity, and adaptive capacity data
source("../R/create_map.R") # function for creating maps
source("../R/calculate_risk.R") # function for calculating risk
# source("../R/sensitivity_analysis.R") # function for running a sensitivity analysis on adaptive capacity variables (Work in Progress)
```

## Calculate the risk index based on a countryâ€™s exposure, sensitivity, and adaptive capacity components.

> Insert your path to get to your data file (line)

```{r calculate risk}
# Change this line based on user
# Connor's desktop path
# file_path <- "C:/Users/cjqui/OneDrive/Desktop/2024-2025/SGL/Chapter 2/data/"
# Connor's laptop path
file_path <- "C:/Users/cjqui/Desktop/SGL/Chapter 2 (trade climate risk)/trade-climate-risk/data/"

# Jessica's path (insert below)
# file_path <- ""


# Get exposure, sensitivty, and adaptive capacity data for entire portfolio
e_s_ac_data_entire_portfolio <- acquire_e_s_ac_data(foreign = FALSE, directory_path = file_path)

# Get exposure, sensitivty, and adaptive capacity data for foreign imports
e_s_ac_data <- acquire_e_s_ac_data(foreign = TRUE, directory_path = file_path)

# Calculate risk
risk_overall <- calculate_risk(e_s_ac_data_entire_portfolio, coverage = "entire portfolio")

risk_foreign_imports <- calculate_risk(e_s_ac_data, coverage = "foreign imports")
  
# Look at correlations between vulnerability and E + S + AC
pairs(risk_foreign_imports[,2:5])
cor_vals <- cor(risk_foreign_imports[,2:5])
```

## Sensitivity analysis on adaptive capacity variables and components

> Note: This is still a work in progress, so results are likely not be reliable at this stage.

```{r run sensitivity analysis}
# # Run sensitivity analysis on foreign import risk
# sensitivity_analysis(data = e_s_ac_data, risk_data = risk_foreign_imports)
# 
# # Run sensitivity analysis on entire portfolio risk
# sensitivity_analysis(data = e_s_ac_data_entire_portfolio, risk_data = risk_overall)
```